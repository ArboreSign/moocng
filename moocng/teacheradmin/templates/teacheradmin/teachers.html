{% extends "teacheradmin/base_teacheradmin.html" %}

{% load i18n gravatar %}

{% block nav-teacheradmin-teachers %}active{% endblock %}

{% block extraheader %}
<script src="{{ STATIC_URL }}js/libs/underscore-1.3.3.min.js" type="text/javascript"></script>
<script type="text/javascript">
$(document).ready(function () {
    "use strict";
    (function ($) {
        $("#invite-teacher").typeahead({
            source: function (query, process) {
                $.getJSON("/api/v1/user/", {
                        format: "json",
                        first_name__istartswith: query,
                        last_name__istartswith: query
                    },
                    function (data, textStatus, jqXHR) {
                        process(_.map(data.objects, function (user) {
                            return user.first_name + " " + user.last_name + " (" + user.id + ")";
                        }));
                    }
                );
            },
            minLength: 1
        });

        var re = /\S+@\S+\.\S+/; // Very simple email validation
        $("#invite-teacher").next().click(function (evt) {
            evt.preventDefault();
            evt.stopPropagation();
            var data = $("#invite-teacher").val(),
                csrf,
                idxA,
                idxB;
            if (!re.test(data)) {
                // Extract id from name
                idxA = data.lastIndexOf('(');
                idxB = data.lastIndexOf(')');
                if (idxA > 0 && idxB > 0) {
                    data = data.substring(idxA + 1, idxB);
                } else {
                    data = ""; // Invalid
                }
            }
            csrf = $("#invite-teacher").parent().parent().parent().find("input[name=csrfmiddlewaretoken]").val();
            $.ajax("{{ request.path }}invite", {
                data: {
                    data: data,
                    csrfmiddlewaretoken: csrf
                },
                dataType: "json",
                type: "POST",
                success: function (data, textStatus, jqXHR) {
                    // TODO update table
                    $(".alert-success").show();
                    setTimeout(function () {
                        $(".alert-success").hide();
                    }, 3500);
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    $(".alert-error").show();
                    setTimeout(function () {
                        $(".alert-error").hide();
                    }, 3500);
                }
            });
        });
    }(jQuery));
});
</script>
{% endblock %}

{% block section %}
<h2>{% trans "Teachers" %}</h2>
<div style="display: none;" class="alert alert-success">
    <h4>{% trans "Success" %}</h4>
    <p>{% trans "The teacher has been added to the course or invited." %}</p>
</div>
<div style="display: none;" class="alert alert-error">
    <h4>{% trans "Error" %}</h4>
    <p>{% trans "Something went wrong, that teacher doesn't exists. Please, introduce a valid user or an email." %}</p>
</div>
<table class="table table-striped">
    <tbody>
        {% for teacher in course.teachers.all %}
        <tr>
            <td>{% gravatar_img_for_user teacher 20 %}</td>
            <td>{% firstof teacher.get_full_name teacher.username %} <a href="mailto:{{ teacher.email }}">&lt;{{ teacher.email }}&gt;</a></td>
            <td></td> <!-- TODO pending badge via templatetag -->
            <td style="text-align: right;"><i class="icon-remove pointer"></i></td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<form action="" method="post" class="form-inline">{% csrf_token %}
    <fieldset>
        <div class="input-append">
            <input id="invite-teacher" class="input-xlarge" type="text" autocomplete="off" placeholder="{% trans "Name or email" %}" />
            <input type="submit" class="btn" value="{% trans "Add" %}" />
        </div>
    </fieldset>
</form>
{% endblock %}
